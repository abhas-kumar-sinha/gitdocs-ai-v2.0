
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============= User & Auth =============

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  
  // Feedback
  feedbackRewarded    Boolean @default(false)

  // per-user limit (default 5 chats/day)
  dailyAiChatLimit    Int @default(5)
  bonusAiChatCredits  Int @default(0)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  installations         Installation[]
  projects              Project[]
  aiUsages              AiUsage[]
  installationProcesses InstallationProcess[]
  feedbacks             Feedback[]

  @@index([clerkId])
  @@index([email])
}

// ============= GitHub App Integration =============

enum Permission {
  READ
  WRITE
}

model Installation {
  id        String   @id @default(cuid())
  userId    String
  
  // GitHub App Installation Info
  installationId   String   @unique // GitHub installation ID
  accountId        String              // GitHub account ID
  accountName      String              // GitHub account name
  accountAvatarUrl String?
  
  // Permissions
  permissions      Permission  @default(READ) // Store granted permissions
  repositorySelection String           // "all" or "selected"
  
  // Installation status
  suspended        Boolean  @default(false)
  suspendedAt      DateTime?
  
  // Timestamps
  installedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositories     Repository[]
  
  @@index([userId])
  @@index([installationId])
}

enum Status {
  COMPLETED
  PENDING
  FAILED
}

model InstallationProcess {
  id        String   @id @default(cuid())
  userId    String

  // Status
  status   Status   @default(PENDING)

  // Authentication
  state    String

  // Permissions
  permissions      Permission  @default(READ) // Store to grant permissions

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Repository {
  id          String   @id @default(cuid())
  installationId String
  
  // GitHub Repository Info
  githubId    String   @unique // GitHub repository ID
  name        String
  fullName    String   // owner/repo
  description String?
  private     Boolean  @default(false)
  defaultBranch String @default("main")
  url         String
  
  // Owner info
  ownerLogin  String
  ownerType   String   // "User" or "Organization"
  
  // Repository metadata
  language    String?
  topics      String[] // Array of topics/tags
  homepage    String?
  size        Int      @default(0)
  stargazers  Int      @default(0)
  watchers    Int      @default(0)
  forks       Int      @default(0)
  openIssues  Int      @default(0)
  
  // README Info
  hasReadme   Boolean  @default(false)
  readmePath  String?  @default("README.md")
  readmeSha   String?  // Git blob SHA for the README
  
  // Last sync info
  lastSyncedAt DateTime?
  syncStatus   String   @default("pending") // pending, syncing, completed, failed
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  installation Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  projects     Project[]
  
  @@index([installationId])
  @@index([githubId])
  @@index([fullName])
}

// ============= Projects & Messages =============

model Project {
  id              String   @id @default(cuid())
  name            String
  userId          String
  repositoryId    String?
  
  // Project metadata
  description     String?
  allFiles        String[] @default([])
  contextFiles    String[] @default([])
  isStarred       Boolean @default(false)
  
  // README generation settings
  autoUpdate      Boolean @default(false)
  template        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository      Repository?  @relation(fields: [repositoryId], references: [id], onDelete: SetNull)
  messages        Message[]
  
  @@index([userId])
  @@index([repositoryId])
}

enum MessageRole {
  USER
  ASSISTANT
}

enum MessageType {
  RESULT
  ERROR
}

model Message {
  id        String      @id @default(cuid())
  content   String      @db.Text
  role      MessageRole
  type      MessageType
  
  model     String?     
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  isHelpful Boolean?
  fragment  Fragment?
  
  @@index([projectId])
  @@index([createdAt])
}

model Fragment {
  id        String   @id @default(cuid())
  
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String   @unique
  
  readme    String   @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([messageId])
}

// ============= Webhooks & Events =============

model WebhookEvent {
  id        String   @id @default(cuid())
  
  // Event details
  eventType String   // installation, installation_repositories, push, etc.
  action    String?  // created, deleted, added, removed, etc.
  
  // GitHub identifiers
  installationId String?
  repositoryId   String?
  senderId       String?  // GitHub user who triggered the event
  
  // Payload
  payload   Json     @db.JsonB
  
  // Processing status
  processed Boolean  @default(false)
  processedAt DateTime?
  error     String?  @db.Text
  
  createdAt DateTime @default(now())
  
  @@index([installationId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

// ============= Rate Limiting & Usage =============

model AiUsage {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  date      DateTime @db.Date

  count     Int      @default(0)
  maxCount  Int      @default(5)

  tokensUsed Int?
  cost       Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============= Usage Feedback =============

model Feedback {
  id             String   @id @default(cuid())

  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  intent         String[]
  outcome        String
  outputQuality  Int
  friction       String
  insight        String
  repoType       String[]
  missingFeature String?
  nps            Int?

  createdAt      DateTime @default(now())

  @@index([userId])
}

